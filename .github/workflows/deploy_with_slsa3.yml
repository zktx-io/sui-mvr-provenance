name: MVR Provenance Full Workflow

description: |
  A reusable GitHub Actions workflow that builds a Move package,
  deploys it with external signing, generates provenance, and
  registers the metadata to MVR with verified integrity.

on:
  workflow_call:
    inputs:
      working-directory:
        required: false
        type: string
        default: '.'

    secrets:
      GIT_SIGNER_PIN:
        required: false
      ED25519_PRIVATE_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: zktx-io/sui-mvr-provenance@v0.0.24
        with:
          working-directory: ${{ inputs.working-directory }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      base64_provenance: ${{ steps.encode.outputs.base64_file }}
      base64_hashes: ${{ steps.encode.outputs.base64_hashes }}
    steps:
      - name: Download Bytecode Dump
        uses: actions/download-artifact@v4
        with:
          name: bytecode.dump.json
          path: .

      - name: Download mvr.config.json
        uses: actions/download-artifact@v4
        with:
          name: mvr.config.json
          path: .

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: zktx-io/sui-mvr-provenance
          ref: v0.0.24
          path: temp

      - name: Run deploy.js from zktx-io/sui-mvr-provenance
        working-directory: ./temp
        env:
          GIT_SIGNER_PIN: ${{ secrets.GIT_SIGNER_PIN }}
          ED25519_PRIVATE_KEY: ${{ secrets.ED25519_PRIVATE_KEY }}
        run: |
          npm ci
          node dist/deploy

      - name: Upload deploy.json
        uses: actions/upload-artifact@v4
        with:
          name: deploy.json
          path: deploy.json
          if-no-files-found: error

      - id: encode
        run: |
          HASHES=""
          for FILE in deploy.json mvr.config.json; do
            if [ ! -f "$FILE" ]; then
              echo "::error::‚ùå $FILE not found"
              exit 1
            fi
            FILE_HASH=$(sha256sum "$FILE" | cut -d ' ' -f 1)
            HASHES+="${FILE_HASH}  ${FILE}"$'\n'
          done

          echo "base64_hashes=$(echo -n "$HASHES" | base64 -w0)" >> "$GITHUB_OUTPUT"

  provenance:
    needs: deploy
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: ${{ needs.deploy.outputs.base64_hashes }}
      upload-assets: false
      provenance-name: 'mvr.intoto.jsonl'

  verify:
    needs: [deploy, provenance]
    runs-on: ubuntu-latest
    steps:
      - name: Download provenance file
        uses: actions/download-artifact@v4
        with:
          name: mvr.intoto.jsonl
          path: .

      - name: Download deploy.json artifacts
        uses: actions/download-artifact@v4
        with:
          name: deploy.json
          path: .

      - name: Download mvr.meta.config artifacts
        uses: actions/download-artifact@v4
        with:
          name: mvr.config.json
          path: .

      - name: Install slsa-verifier
        run: |
          curl -sSfL https://github.com/slsa-framework/slsa-verifier/releases/latest/download/slsa-verifier-linux-amd64 -o slsa-verifier
          chmod +x slsa-verifier
          sudo mv slsa-verifier /usr/local/bin/

      - name: Verify all provenance files
        run: |
          for FILE in deploy.json mvr.config.json; do
            echo "üîç Verifying $FILE..."
            slsa-verifier verify-artifact "$FILE" \
              --provenance-path mvr.intoto.jsonl \
              --source-uri "github.com/${{ github.repository }}" \
              || {
                echo "::error::‚ùå Verification failed for $FILE"
                exit 1
              }
          done

  mvr-register:
    needs: [deploy, provenance, verify]
    runs-on: ubuntu-latest
    steps:
      - name: Download mvr.meta.config artifacts
        uses: actions/download-artifact@v4
        with:
          name: mvr.config.json
          path: .

      - name: Check for valid package_name and package_desc in mvr.config.json
        run: |
          PACKAGE_NAME=$(jq -r '.package_name // empty' mvr.config.json)
          PACKAGE_DESC=$(jq -r '.package_desc // empty' mvr.config.json)

          if [[ -z "$PACKAGE_NAME" ]]; then
            echo "::warning::‚ö†Ô∏è 'package_name' is missing in mvr.config.json. Skipping MVR registration."
            exit 0
          fi

          if [[ ! "$PACKAGE_NAME" =~ ^@[^/]+\/[^/]+$ ]]; then
            echo "::warning::‚ö†Ô∏è 'package_name' must be in the format '@suinsName/appName' (e.g. @mvr/app). Skipping MVR registration."
            exit 0
          fi

          if [[ -z "$PACKAGE_DESC" ]]; then
            echo "::warning::‚ö†Ô∏è 'package_desc' is missing. Skipping MVR registration."
            exit 0
          fi

      - name: Download provenance file
        uses: actions/download-artifact@v4
        with:
          name: mvr.intoto.jsonl
          path: .

      - name: Download deploy.json artifacts
        uses: actions/download-artifact@v4
        with:
          name: deploy.json
          path: .

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: zktx-io/sui-mvr-provenance
          ref: v0.0.24
          path: temp

      - name: Run deploy.js from zktx-io/sui-mvr-provenance
        working-directory: ./temp
        env:
          GIT_SIGNER_PIN: ${{ secrets.GIT_SIGNER_PIN }}
          ED25519_PRIVATE_KEY: ${{ secrets.ED25519_PRIVATE_KEY }}
        run: |
          npm ci
          node dist/register
