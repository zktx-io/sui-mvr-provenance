name: MVR Provenance Full Workflow

description: |
  A reusable GitHub Actions workflow that builds a Move package,
  deploys it with external signing, generates provenance, and
  registers the metadata to MVR with verified integrity.

on:
  workflow_call:
    inputs:
      working-directory:
        required: false
        type: string
        default: '.'

    secrets:
      GIT_SIGNER_PIN:
        required: false
      ED25519_PRIVATE_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: zktx-io/sui-mvr-provenance@v0.0.3
        with:
          working-directory: ${{ inputs.working-directory }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: download
        uses: actions/download-artifact@v4
        with:
          name: bytecode.dump.json

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run deploy script
        env:
          ED25519_PRIVATE_KEY: ${{ secrets.ED25519_PRIVATE_KEY }}
        run: |
          node dist/deploy.js \
            --dump bytecode.dump.json \
            --config mvr.config.json \
            --key "$ED25519_PRIVATE_KEY"
